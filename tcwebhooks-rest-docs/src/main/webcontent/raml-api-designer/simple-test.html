<!doctype html>
<html role="api-designer">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>API Designer</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="dist/styles/api-designer-vendor.css"/>

    <link rel="stylesheet" href="dist/styles/api-designer.css"/>
  </head>
  <body ng-app="ramlEditorApp">
    <div class="container">
        <raml-editor></raml-editor>
    </div>

    <script src="dist/scripts/api-designer-vendor.js"></script>
    <script src="dist/scripts/api-designer.js"></script>
    <script>
        var files = {};
      // This part is needed only if you want to provide your own Persistance Implementation
      // Angular Module must match "ramlEditorApp"
      angular.module('ramlEditorApp')
      .factory('MyFileSystem', function ($http, $q, config, $rootScope) {
        var service = {};
        service.directory = function (path) {
          var deferred = $q.defer();
        
          $http({
            method: 'GET',
            data: '',
            url : '/raml/file',
            withCredentials: false
           }).success(function (data, status, headers, config) {
                 Object.keys(files).forEach(function (key) {
                       delete files[key];
                 });
                 
                 Object.keys(data.children).forEach(function (id){
                 	files[data.children[id].path] = data.children[id];
                 	console.log(data.children[id].path);
                 	console.log(data.children[id].name);
                 	if (data.children[id].children !== null){
                 		eachRecursive(data.children[id].children);
                 	}
                 });
                 
                 deferred.resolve(data);
               })
           .error(deferred.reject.bind(deferred));
  
           return deferred.promise;
        };
        service.load = function (path, name) {
          var deferred = $q.defer();
    
          $http({
            method: 'GET',
            data: '',
            url : '/raml/file'+path,
            withCredentials: false
           }).success(function (data, status, headers, config) {
                 deferred.resolve(decodeURI(data.contents));
               })
           .error(deferred.reject.bind(deferred));
           return deferred.promise;
        };
        service.remove = function (path, name) {
          var deferred = $q.defer();
          
          if (!files[path]) {
                deferred.reject('file with path="' + path + '" does not exist');
                return deferred.promise;
           }
          $http({
            method: 'DELETE',
            data: '',
            url : '/raml/file'+path,
            withCredentials: false
           }).success(function (data, status, headers, config) {
                 delete files[path];
                 deferred.resolve();
               })
           .error(deferred.reject.bind(deferred));
 
           return deferred.promise;
        };
        service.save = function (path, contents) {
          var deferred = $q.defer();
          var payload = new Object();
          var fileId = files[path];
          //payload["name"] = name;
          payload["path"] = path;
          payload["contents"] = encodeURI(contents);
 
          // Existing file
          if (fileId) {    
              
          $http({
            method: 'PUT',
            data: JSON.stringify(payload),
            url : '/raml/file/'+fileId,
            withCredentials: false
           }).success(deferred.resolve.bind(deferred))
           .error(deferred.reject.bind(deferred));
                       
          }
          // New File
          else {    
          $http({
            method: 'POST',
            data: JSON.stringify(payload),
            url : '/raml/file/',
            withCredentials: false
           }).success(function (data, status, headers, config) {
                 files[data.path] = data;
                 deferred.resolve({entry: name, content: payload["contents"], id: data.path});
               })
           .error(deferred.reject.bind(deferred));
          }
    
           return deferred.promise;
        };
        return service;
      })
      .run(function (MyFileSystem, config, $rootScope) {
        // Set MyFileSystem as the filesystem to use
        config.set('fsFactory', 'MyFileSystem');
        
        // In case you want to send notifications to the user
        // (for instance, that he must login to save).
        // The expires flags means whether
        // it should be hidden after a period of time or the
        // user should dismiss it manually.
        $rootScope.$broadcast('event:notification',
          {message: 'File saved.', expires: true});
      });
      
      
		function eachRecursive(obj)	{
		    for (var k in obj)
		    {
		        if (typeof obj[k] == "object" && obj[k] !== null)
		            eachRecursive(obj[k]);
		        else {
		        	if (k == "path"){
		        		var filenameAndPath = obj[k];
		        		files[filenameAndPath] = obj;
		        	} 
		        }
		    }
		}
    </script>
    
    
  </body>
</html>
